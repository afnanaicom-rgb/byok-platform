rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== USERS COLLECTION =====
    match /users/{userId} {
      // Users can read/write their own document
      allow read, write: if request.auth.uid == userId;
      
      // Admin can read all user documents
      allow read: if request.auth.token.admin == true;
      
      // ===== API KEYS SUBCOLLECTION =====
      match /apiKeys/{document=**} {
        // Users can read/write their own API keys (but encrypted)
        allow read, write: if request.auth.uid == userId;
        
        // Admin can read all API keys
        allow read: if request.auth.token.admin == true;
        
        // Admin can delete API keys
        allow delete: if request.auth.token.admin == true;
      }
      
      // ===== MESSAGES SUBCOLLECTION =====
      match /messages/{document=**} {
        // Users can read/write their own messages
        allow read, write: if request.auth.uid == userId;
        
        // Admin can read all messages
        allow read: if request.auth.token.admin == true;
      }
    }
    
    // ===== DENY ALL OTHER ACCESS =====
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
